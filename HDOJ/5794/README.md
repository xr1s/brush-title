# A Simple Chess

一点都不 simple 哦. 明天有一场 2018 杭电多校的我半夜在刷一道 2016 杭电多校.

一个 (n, m) 的棋盘, 有一只马在 (1, 1) 的位置, 马只能走日, 且只能往下和往右走 (每次前进的两个坐标都必须增加). 鹿上有 100 不到的个障碍, 马不能落到障碍上. 问走到 (n, m) 有多少种走法.

此题的 n, m 巨大, 都是 1e18 范围的, 无论如何都不可能从这里下手, 考虑到障碍数量较少, 可以从这里下手.

首先应该意识到, 当给出了坐标差 (dx, dy), 可以直接求出横走几步 (设为 h) 纵走几步 (设为 v), 可以列出方程: h + 2v = dx, 2h + v = dy, 这样的话不考虑障碍物就有 binom(h + v, h) 种走法. 因为此处模数较小, 考虑用 Lucas 定理求组合数. 直接 Lucas 时间还是过长, 继续考虑给阶乘和逆元打表. 于是这里就可以以底数为 110119 的对数复杂度求解.

考虑从一个位置转移到另一个位置的问题, 设 dp[i] 为从起点转移到第 i 个位置的可行步数, 设 approaches(dx, dy) 为坐标差为 (dx, dy) 时可行的步数, 则 d[i] = approaches(x[i] - 1, y[i] - 1) - sum{d[j] * approaches(x[j] - x[i], y[j] - y[i]) for j in range(i)}, 含义就是到 i 的可行步数为不计障碍的可行步数减去所有从之前障碍 j 到 i 的可行步数.

当然, 靠近原点的应当先被转移, 所以按照 (x, y) 排个序还是必要的.

总复杂度是预处理复杂度: $O(p+p\log p)$, 排序复杂度: $O(r\log r)$, 转移复杂度 $O(r^2\log_p\min(m,n))$.
